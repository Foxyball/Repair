package repair;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import javax.swing.JOptionPane;
import javax.swing.Timer;
import javax.swing.table.DefaultTableModel;

public class userListPanel extends javax.swing.JPanel {

    DefaultTableModel model;
    config q = new config();
    private AdminForm adminForm;
    private Timer timer;

    public userListPanel(AdminForm adminForm) {
        initComponents();

        this.adminForm = adminForm;
        jLabel2.setVisible(false); // Резултати от търсене етикет

        jButton1.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                adminForm.switchToUserAddPanel();
            }
        });

        timer = new Timer(50000, new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                refreshUserList();
            }
        });

        timer.start();

        String[] cols = {"id", "Име", "Имейл", "Телефон", "Град", "Статус", "ЕГН", "ПКОД", "Достъп", "Фирма", "Фирма име", "Фирма ЕИК", "Фирма МОЛ", "Фирма ДДС", "Фирма адрес"};
        model = new DefaultTableModel(cols, 0);

        // Прави таблицата да не се едитва
        jTable1.setDefaultEditor(Object.class, null);

        String filter = "";
        ArrayList<User> users = q.loadUserData(filter);

        for (User user : users) {
            Object[] row = userToArr(user);
            model.addRow(row);
        }

        jTable1.setModel(model);

    }

    // функция за връщане свойствата на обекта под формата на масив
    private Object[] userToArr(User user) {

        String isFirm;
        if (user.getIsFirm() == 1) {
            isFirm = "Да";
        } else {
            isFirm = "Не";
        }

        String role;
        if (user.getRole().equals("admin")) {
            role = "Администратор";
        } else {
            role = "Клиент";
        }

        String status;
        if (user.getStatus().equals("active")) {
            status = "Активен";
        } else {
            status = "Неактивен";
        }

        return new Object[]{
            user.getUserId(),
            user.getName(),
            user.getEmail(),
            user.getPhone(),
            user.getCity(),
            status,
            user.getEGN(),
            user.getPKOD(),
            role,
            isFirm,
            user.getFirmName(),
            user.getFirmEIK(),
            user.getFirmMOL(),
            user.getFirmDDS(),
            user.getFirmAddress()
        };
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();
        jButton3 = new javax.swing.JButton();
        jButton4 = new javax.swing.JButton();
        jButton5 = new javax.swing.JButton();
        jTextField1 = new javax.swing.JTextField();
        jLabel1 = new javax.swing.JLabel();
        jButton6 = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jButton7 = new javax.swing.JButton();

        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {},
                {},
                {},
                {}
            },
            new String [] {

            }
        ));
        jScrollPane1.setViewportView(jTable1);

        jButton1.setText("Добавяне");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        jButton2.setText("Редактиране");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });

        jButton3.setText("Изтриване");
        jButton3.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton3ActionPerformed(evt);
            }
        });

        jButton4.setText("Обнови");
        jButton4.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton4ActionPerformed(evt);
            }
        });

        jButton5.setText("Търсене");
        jButton5.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton5ActionPerformed(evt);
            }
        });

        jTextField1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jTextField1ActionPerformed(evt);
            }
        });

        jLabel1.setFont(new java.awt.Font("Segoe UI", 0, 24)); // NOI18N
        jLabel1.setText("ВСИЧКИ ПОТРЕБИТЕЛИ");

        jButton6.setText("Експорт");

        jLabel2.setText("Резултати: 0");

        jButton7.setText("Изпрати Имейл");
        jButton7.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton7ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(14, 14, 14)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 960, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jButton1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton2)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButton6)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1)
                            .addGroup(jPanel1Layout.createSequentialGroup()
                                .addComponent(jButton4)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jButton7)
                                .addGap(41, 41, 41)
                                .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, 202, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jButton5)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jLabel2)))))
                .addContainerGap(43, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addGap(51, 51, 51)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jButton5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jLabel2))
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jButton1)
                        .addComponent(jButton2)
                        .addComponent(jButton3)
                        .addComponent(jButton4)
                        .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jButton6)
                        .addComponent(jButton7)))
                .addGap(18, 18, 18)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 469, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jButton1ActionPerformed

    // Прихващане на полетата при клик на ред от таблицата
    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        int selectedRow = jTable1.getSelectedRow();
        if (selectedRow != -1) {

            // Кастване на ID-то към int от String
            String idString = jTable1.getValueAt(selectedRow, 0).toString();
            int userId = Integer.parseInt(idString);

            // Извикване на универсалния метод select
            String[] columns = {"id", "name", "email", "phone", "city", "status", "egn", "pkod", "role", "is_firm", "firm_name", "firm_eik", "firm_mol", "firm_dds", "firm_address"};
            String whereClause = "id = ?";
            Object[] params = {userId};

            ArrayList<String> result = q.select(columns, "users", whereClause, params);

            if (!result.isEmpty()) {
                // Разделяне на първия (и единствен) ред на масив от стойности
                String[] userData = result.get(0).split("---");

                int id = Integer.parseInt(userData.length > 0 ? userData[0] : "0");
                String name = userData.length > 1 ? userData[1] : "";
                String email = userData.length > 2 ? userData[2] : "";
                String phone = userData.length > 3 ? userData[3] : "";
                String city = userData.length > 4 ? userData[4] : "";
                String status = userData.length > 5 ? userData[5] : "";
                String egn = userData.length > 6 ? userData[6] : "";
                String pkod = userData.length > 7 ? userData[7] : "";
                String role = userData.length > 8 ? userData[8] : "";
                String is_firm = userData.length > 9 ? userData[9] : "";
                String firm_name = userData.length > 10 ? userData[10] : "";
                String firm_eik = userData.length > 11 ? userData[11] : "";
                String firm_mol = userData.length > 12 ? userData[12] : "";
                String firm_dds = userData.length > 13 ? userData[13] : "";
                String firm_address = userData.length > 14 ? userData[14] : "";

                // Подаване на данните към панела за редактиране, за да се визуализират
                adminForm.switchToUserEditPanel(id, name, email, phone, city, status, egn, pkod, role, is_firm, firm_name, firm_eik, firm_mol, firm_dds, firm_address);
            } else {
                JOptionPane.showMessageDialog(this, "Не е намерен потребител с този ID!");
            }
        } else {
            JOptionPane.showMessageDialog(this, "Моля, изберете ред от таблицата!");
        }

    }//GEN-LAST:event_jButton2ActionPerformed

    // Бутон за обновяване
    private void jButton4ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton4ActionPerformed
        refreshUserList();
    }//GEN-LAST:event_jButton4ActionPerformed


    private void jTextField1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jTextField1ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jTextField1ActionPerformed

    // Търсачка
    private void jButton5ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton5ActionPerformed
        String keyword = jTextField1.getText().trim();

        if (keyword.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Моля, въведете ключова дума за търсене!", "Грешка", JOptionPane.ERROR_MESSAGE);
            return;
        }

        String[] columns = {"id", "name", "email", "phone", "city", "status", "egn", "pkod", "role", "is_firm", "firm_name", "firm_eik", "firm_mol", "firm_dds", "firm_address"};
        String whereClause = "name LIKE ? OR email LIKE ? OR phone LIKE ? OR city LIKE ?";
        Object[] params = {"%" + keyword + "%", "%" + keyword + "%", "%" + keyword + "%", "%" + keyword + "%"};

        ArrayList<String> searchResults = q.select(columns, "users", whereClause, params);

        String[] columnNames = {"id", "Име", "Имейл", "Телефон", "Град", "Статус", "ЕГН", "ПКОД", "Достъп", "Фирма", "Фирма име", "Фирма ЕИК", "Фирма МОЛ", "Фирма ДДС", "Фирма адрес"};
        DefaultTableModel model = new DefaultTableModel(columnNames, 0);

        // Populate the table model with data
        for (String row : searchResults) {
            String[] userData = row.split("---");
            model.addRow(userData);
        }

        jTable1.setModel(model);
        jTable1.setDefaultEditor(Object.class, null);

        // Display the number of search results
        jLabel2.setVisible(true);
        int resultCount = searchResults.size();
        jLabel2.setText("Резултати: " + resultCount);
    }//GEN-LAST:event_jButton5ActionPerformed

    // Изтриване бутон, избира се ред от таблицата, прихваща id-то и изпълнява заявката
    private void jButton3ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton3ActionPerformed
        int selectedRow = jTable1.getSelectedRow();

        if (selectedRow == -1) {
            JOptionPane.showMessageDialog(this, "Моля, изберете потребител за изтриване.");
            return;
        }

        // Кастване на ID-то към int от String
        String idString = jTable1.getValueAt(selectedRow, 0).toString();
        int userId = Integer.parseInt(idString);

        int confirm = JOptionPane.showConfirmDialog(this, "Сигурни ли сте, че искате да изтриете този потребител?", "Потвърждение", JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            // Use the universal delete method
            boolean isDeleted = q.delete("users", "id", userId); // Pass userId directly instead of params array

            if (isDeleted) {
                refreshUserList();
                JOptionPane.showMessageDialog(this, "Потребителят е изтрит успешно.");
            } else {
                JOptionPane.showMessageDialog(this, "Грешка при изтриване на потребителя.");
            }
        }
    }//GEN-LAST:event_jButton3ActionPerformed

    // Изпрати имейл бутон [Ръчно]
    private void jButton7ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton7ActionPerformed
        int selectedRow = jTable1.getSelectedRow();
        if (selectedRow != -1) {

            String email = jTable1.getValueAt(selectedRow, 2).toString();
            String userName = jTable1.getValueAt(selectedRow, 1).toString();

            new SendEmailForm(email, userName).setVisible(true);
        } else {
            JOptionPane.showMessageDialog(this, "Моля, изберете потребител.");
        }
    }//GEN-LAST:event_jButton7ActionPerformed

    // Обновяване на данните с бутон
    public void refreshUserList() {
        String[] columns = {"id", "name", "email", "phone", "city", "status", "egn", "pkod", "role", "is_firm",
            "firm_name", "firm_eik", "firm_mol", "firm_dds", "firm_address"};
        String table = "users";
        String whereClause = "";
        Object[] params = null;

        ArrayList<String> userList = q.select(columns, table, whereClause, params);

        String[] cols = {"id", "Име", "Имейл", "Телефон", "Град", "Статус", "ЕГН", "ПКОД", "Достъп", "Фирма", "Фирма име", "Фирма ЕИК", "Фирма МОЛ", "Фирма ДДС", "Фирма адрес"};
        DefaultTableModel model = new DefaultTableModel(cols, 0);

        for (String user : userList) {
            String[] userDetails = user.split("---");
            
            // Обхожда масива и проверява за null стойности, за да ги визуализира като празна клетка, а не null
            for (int i = 0; i < userDetails.length; i++) {
                if (userDetails[i] == null || userDetails[i].equals("null")) {
                    userDetails[i] = "";
                }
            }
            userDetails[9] = userDetails[9].equals("1") ? "Да" : "Не";

            if (userDetails[8].equals("admin")) {
                userDetails[8] = "Администратор";
            } else {
                userDetails[8] = "Клиент";
            }

            if (userDetails[5].equals("active")) {
                userDetails[5] = "Активен";
            } else {
                userDetails[5] = "Неактивен";
            }

            model.addRow(userDetails);
        }

        jTable1.setModel(model);

        // да не може да се редактира в самата таблица
        jTable1.setDefaultEditor(Object.class, null);

        // Скриване на резултати: 4
        jLabel2.setVisible(false);
        jTextField1.setText("");
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JButton jButton3;
    private javax.swing.JButton jButton4;
    private javax.swing.JButton jButton5;
    private javax.swing.JButton jButton6;
    private javax.swing.JButton jButton7;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable jTable1;
    private javax.swing.JTextField jTextField1;
    // End of variables declaration//GEN-END:variables
}
